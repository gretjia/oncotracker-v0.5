<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Patient Journey | Advanced Controls</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' },
                        brand: { primary: '#2563eb', alert: '#dc2626' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    screens: { 'xs': '480px' }
                }
            }
        }
    </script>

    <style>
        /* --- CORE LAYOUT --- */
        html,
        body {
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            background-color: #f8fafc;
            color: #0f172a;
            -webkit-tap-highlight-color: transparent;
        }

        body.resizing {
            cursor: row-resize;
            user-select: none;
        }

        body.resizing * {
            pointer-events: none;
        }

        #chart-container {
            touch-action: none;
            background-color: #ffffff;
            cursor: crosshair;
        }

        aside {
            touch-action: pan-y;
        }

        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        .axis text {
            fill: #64748b;
            font-size: 10px;
            font-weight: 500;
        }

        .axis path,
        .axis line {
            stroke: #e2e8f0;
        }

        .custom-checkbox:checked {
            background-color: currentColor;
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }

        .expand-transition {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Alert Animation */
        @keyframes pulse-alert {
            0% {
                stroke-width: 0px;
                stroke-opacity: 0.6;
            }

            100% {
                stroke-width: 8px;
                stroke-opacity: 0;
            }
        }

        .alert-dot-pulse {
            animation: pulse-alert 2s infinite;
            transform-origin: center;
            stroke: #ef4444;
            fill: none;
        }

        @media print {
            @page {
                size: A4 landscape;
                margin: 0mm;
                /* Zero margin for full bleed */
            }

            body {
                margin: 0mm !important;
                /* Remove safety margin */
            }

            body,
            html {
                height: 100% !important;
                width: 100% !important;
                overflow: visible !important;
                background: white !important;
            }

            header,
            .no-print-ui,
            #layout-resizer,
            #zoom-controls {
                display: none !important;
            }

            #main-wrapper {
                display: block !important;
                height: 100% !important;
            }

            main {
                height: 100% !important;
                width: 100% !important;
                flex: none !important;
            }

            aside {
                display: none !important;
            }

            #metric-controls-container {
                display: none !important;
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
</head>

<body class="font-sans flex flex-col">

    <!-- HEADER -->
    <header
        class="h-12 bg-white border-b border-slate-200 flex items-center justify-between px-4 flex-shrink-0 z-30 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-7 h-7 bg-slate-900 rounded flex items-center justify-center text-white shadow-sm">
                <i class="fa-solid fa-chart-line text-xs"></i>
            </div>
            <div>
                <h1 class="text-xs font-bold text-slate-900 uppercase tracking-wide">Patient Journey</h1>
                <div class="text-[9px] text-slate-500 font-mono">ADVANCED UI</div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="resetSettings()"
                class="print:hidden bg-white text-slate-500 hover:text-red-600 border border-slate-200 hover:border-red-300 px-3 py-1.5 rounded shadow-sm text-xs font-medium transition-colors flex items-center gap-2">
                <i class="fa-solid fa-rotate-left"></i> Reset
            </button>
            <button onclick="window.print()"
                class="print:hidden bg-white text-slate-700 hover:text-blue-600 border border-slate-200 hover:border-blue-300 px-3 py-1.5 rounded shadow-sm text-xs font-medium transition-colors flex items-center gap-2">
                <i class="fa-solid fa-print"></i> Print
            </button>
        </div>
    </header>

    <!-- CONTENT -->
    <div id="main-wrapper" class="flex-1 flex flex-col min-h-0 overflow-hidden bg-slate-50">

        <!-- CHART SECTION -->
        <main id="chart-pane" class="flex flex-col bg-white relative w-full border-b border-slate-200 z-0 min-h-0"
            style="flex: 2;">

            <!-- Title -->
            <div id="chart-title" class="text-center py-2 border-b border-slate-100 bg-white shrink-0">
                <h2 class="text-sm font-bold text-slate-800">Timeline of Cancer Treatment and Monitoring in Patient</h2>
            </div>

            <!-- Chart Canvas -->
            <div class="flex-1 relative w-full group min-h-0" id="chart-container"></div>

            <!-- Integrated Toolbar (Legend + Zoom) -->
            <div id="toolbar-row"
                class="h-10 border-t border-slate-100 bg-slate-50/50 flex items-center px-3 justify-between shrink-0">

                <!-- Left: Legend -->
                <div class="flex items-center gap-3 overflow-x-auto no-scrollbar flex-1 mr-4">
                    <div class="text-[9px] font-bold text-slate-400 uppercase whitespace-nowrap flex-shrink-0">
                        <i class="fa-solid fa-layer-group mr-1"></i>Active:
                    </div>
                    <div id="active-legend" class="flex items-center gap-2 pr-2"></div>
                </div>

                <!-- Phase Opacity Slider -->
                <div class="flex items-center gap-2 mr-4 border-l border-slate-200 pl-3 no-print-ui">
                    <span class="text-[9px] font-bold text-slate-400 uppercase">背景透明度</span>
                    <input type="range" min="0" max="1" step="0.05" value="0.15"
                        class="w-16 h-1 bg-slate-200 rounded-lg appearance-none accent-slate-500 cursor-pointer"
                        oninput="updatePhaseOpacity(this.value)" title="Adjust Phase Background Opacity">
                </div>

                <!-- Right: Zoom Tools (Moved here for UX) -->
                <div
                    class="flex items-center gap-1 flex-shrink-0 pl-3 border-l border-slate-200 bg-slate-50/50 no-print-ui">
                    <i class="fa-solid fa-arrows-left-right text-[9px] text-slate-500 mr-0.5"></i>
                    <span class="text-[10px] font-bold text-slate-500 mr-1">横纵比：</span>
                    <button onclick="zoomChart(1.2)"
                        class="w-6 h-6 flex items-center justify-center rounded hover:bg-white hover:shadow-sm border border-transparent hover:border-slate-200 text-slate-500 transition-all"
                        title="Zoom In">
                        <i class="fa-solid fa-plus text-xs"></i>
                    </button>
                    <button onclick="zoomChart(0.8)"
                        class="w-6 h-6 flex items-center justify-center rounded hover:bg-white hover:shadow-sm border border-transparent hover:border-slate-200 text-slate-500 transition-all"
                        title="Zoom Out">
                        <i class="fa-solid fa-minus text-xs"></i>
                    </button>
                    <button onclick="resetChartZoom()"
                        class="h-6 px-2 flex items-center justify-center gap-1 rounded hover:bg-white hover:shadow-sm border border-transparent hover:border-slate-200 text-slate-600 text-[10px] font-bold transition-all ml-1"
                        title="Reset View">
                        全病程
                    </button>
                </div>

                <!-- Y-Axis Zoom Tools -->
                <div
                    class="flex items-center gap-1 flex-shrink-0 pl-3 border-l border-slate-200 bg-blue-50/30 no-print-ui">
                    <i class="fa-solid fa-arrows-up-down text-[9px] text-blue-600 mr-0.5"></i>
                    <span class="text-[10px] font-bold text-slate-500 mr-1">纵横比：</span>
                    <button onclick="zoomYAxis(1.2)"
                        class="w-6 h-6 flex items-center justify-center rounded hover:bg-white hover:shadow-sm border border-transparent hover:border-slate-200 text-slate-500 transition-all"
                        title="Zoom In (Y-axis)">
                        <i class="fa-solid fa-plus text-xs"></i>
                    </button>
                    <button onclick="zoomYAxis(0.8)"
                        class="w-6 h-6 flex items-center justify-center rounded hover:bg-white hover:shadow-sm border border-transparent hover:border-slate-200 text-slate-500 transition-all"
                        title="Zoom Out (Y-axis)">
                        <i class="fa-solid fa-minus text-xs"></i>
                    </button>
                    <button onclick="autoFitYAxis()"
                        class="h-6 px-2 flex items-center justify-center gap-1 rounded hover:bg-white hover:shadow-sm border border-transparent hover:border-slate-200 text-slate-600 text-[10px] font-bold transition-all ml-1"
                        title="Auto-fit Y-axis">
                        自适应
                    </button>
                </div>
            </div>

            <!-- Tooltip -->
            <div id="tooltip"
                class="absolute opacity-0 bg-white/95 backdrop-blur border border-slate-200 p-3 rounded-lg shadow-xl z-50 text-xs min-w-[160px] pointer-events-none transition-opacity duration-100">
                <div id="tooltip-header" class="flex justify-between items-center border-b border-slate-100 pb-1 mb-1">
                    <span id="tooltip-date" class="font-mono font-bold text-slate-900"></span>
                    <span id="tooltip-cycle"
                        class="bg-slate-100 px-1.5 py-0.5 rounded text-[9px] font-bold text-slate-600"></span>
                </div>
                <div id="tooltip-body" class="space-y-1"></div>
                <div id="tooltip-footer"
                    class="mt-1 pt-1 border-t border-slate-100 text-[9px] text-slate-500 italic hidden"></div>
            </div>
        </main>

        <!-- CONTROLS SECTION -->
        <aside id="controls-pane" class="bg-slate-50 flex flex-col z-10 min-h-0 overflow-hidden" style="flex: 1;">
            <div
                class="px-4 py-2 border-b border-slate-200 bg-white flex gap-4 items-center justify-between shrink-0 shadow-[0_2px_5px_rgba(0,0,0,0.02)]">
                <div class="flex gap-4 items-center flex-1">
                    <div>
                        <div class="text-[9px] text-slate-400 font-bold uppercase">Range</div>
                        <div class="text-[10px] font-mono font-bold text-slate-900" id="kpi-range">--</div>
                    </div>
                    <div class="w-px h-4 bg-slate-200"></div>
                    <div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase">Points</div>
                        <div class="text-[10px] font-mono font-bold text-blue-600" id="kpi-points">0</div>
                    </div>
                    <div class="w-px h-4 bg-slate-200"></div>
                    <div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase text-red-500">Alerts</div>
                        <div class="text-[10px] font-mono font-bold text-red-600" id="kpi-alerts">0</div>
                    </div>
                </div>
                <div class="flex gap-2 no-print-ui">
                    <label
                        class="flex items-center gap-1.5 px-2 py-1 bg-white rounded border border-slate-200 cursor-pointer shadow-sm hover:bg-slate-50 transition-colors select-none">
                        <input type="checkbox" id="toggle-phases" checked
                            class="custom-checkbox w-3.5 h-3.5 rounded text-blue-600 border-slate-300 focus:ring-0">
                        <span class="text-xs font-bold text-slate-600">周期</span>
                    </label>
                    <label
                        class="flex items-center gap-1.5 px-2 py-1 bg-white rounded border border-slate-200 cursor-pointer shadow-sm hover:bg-slate-50 transition-colors select-none">
                        <input type="checkbox" id="toggle-events" checked
                            class="custom-checkbox w-3.5 h-3.5 rounded text-red-500 border-slate-300 focus:ring-0">
                        <span class="text-xs font-bold text-slate-600">项目</span>
                    </label>
                    <label
                        class="flex items-center gap-1.5 px-2 py-1 bg-white rounded border border-slate-200 cursor-pointer shadow-sm hover:bg-slate-50 transition-colors select-none">
                        <input type="checkbox" id="toggle-schemes"
                            class="custom-checkbox w-3.5 h-3.5 rounded text-emerald-600 border-slate-300 focus:ring-0">
                        <span class="text-xs font-bold text-slate-600">方案</span>
                    </label>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-2 bg-slate-50">
                <div id="metric-controls-container"
                    class="grid grid-cols-1 xs:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 pb-10"></div>
            </div>
        </aside>
    </div>

    <script>
        // --- 1. RESIZER REMOVED ---


        // --- 2. FULL DATASET ---
        const sourceData = {
    "FormalDataset": [
        {},
        {
            "Unnamed: 0": "肿瘤病程周期表"
        },
        {
            "Unnamed: 0": "分类",
            "Unnamed: 1": "节拍",
            "Unnamed: 5": "事件",
            "Unnamed: 7": "体能负荷",
            "Unnamed: 10": "分子负荷",
            "Unnamed: 20": "影像负荷",
            "Unnamed: 24": "副作用"
        },
        {
            "Unnamed: 0": "子类",
            "Unnamed: 1": "项目",
            "Unnamed: 2": "周期",
            "Unnamed: 4": "方案",
            "Unnamed: 5": "处置",
            "Unnamed: 6": "方案",
            "Unnamed: 7": "Weight",
            "Unnamed: 8": "Handgrip",
            "Unnamed: 9": "ECOG",
            "Unnamed: 10": "MRD",
            "Unnamed: 11": "aMRD",
            "Unnamed: 12": "CEA",
            "Unnamed: 13": "HE4",
            "Unnamed: 14": "CA19-9",
            "Unnamed: 15": "CA724",
            "Unnamed: 16": "ROMA绝经后指数",
            "Unnamed: 17": "ROMA绝经前指数",
            "Unnamed: 18": "CA125",
            "Unnamed: 19": "AFP",
            "Unnamed: 20": "肺",
            "Unnamed: 21": "肝脏",
            "Unnamed: 22": "淋巴",
            "Unnamed: 23": "盆腔",
            "Unnamed: 24": "白细胞",
            "Unnamed: 25": "血小板",
            "Unnamed: 26": "中性粒细胞",
            "Unnamed: 27": "谷草转氨酶",
            "Unnamed: 28": "谷丙转氨酶"
        },
        {
            "Unnamed: 0": "日期\\单位",
            "Unnamed: 2": "当下周期",
            "Unnamed: 3": "前序周期",
            "Unnamed: 7": "KG",
            "Unnamed: 8": "KG",
            "Unnamed: 10": "mtm/ml",
            "Unnamed: 11": "mtm/ml",
            "Unnamed: 12": "<5",
            "Unnamed: 13": "<76.2",
            "Unnamed: 14": "<30",
            "Unnamed: 15": "<8.94",
            "Unnamed: 16": "<29.9",
            "Unnamed: 17": "<11.4",
            "Unnamed: 18": "<35",
            "Unnamed: 19": "<7",
            "Unnamed: 20": "mm",
            "Unnamed: 21": "mm",
            "Unnamed: 22": "mm",
            "Unnamed: 23": "mm"
        },
        {
            "Unnamed: 0": "2024-06-06 00:00:00",
            "Unnamed: 1": "腹腔镜",
            "Unnamed: 2": "C0D1",
            "Unnamed: 5": "Dx lap",
            "Unnamed: 7": "45.6"
        },
        {
            "Unnamed: 0": "2024-06-06 00:00:00",
            "Unnamed: 1": "HEPIC",
            "Unnamed: 5": "HEPIC x3",
            "Unnamed: 6": " PTX 90mg"
        },
        {
            "Unnamed: 0": "2024-06-07 00:00:00",
            "Unnamed: 6": "OXA"
        },
        {
            "Unnamed: 0": "2024-06-11 00:00:00",
            "Unnamed: 6": " PTX"
        },
        {
            "Unnamed: 0": "2024-06-18 00:00:00",
            "Unnamed: 10": "2.88"
        },
        {
            "Unnamed: 0": "2024-07-03 00:00:00",
            "Unnamed: 1": "腹腔镜探查",
            "Unnamed: 5": "Dx lap",
            "Unnamed: 7": "45"
        },
        {
            "Unnamed: 0": "2024-07-17 00:00:00",
            "Unnamed: 10": "29.87"
        },
        {
            "Unnamed: 0": "2024-07-18 00:00:00",
            "Unnamed: 12": "1.24",
            "Unnamed: 13": "50.7",
            "Unnamed: 14": "18",
            "Unnamed: 16": "20.4",
            "Unnamed: 17": "8.43",
            "Unnamed: 18": "35.1",
            "Unnamed: 19": "0.91"
        },
        {
            "Unnamed: 0": "2024-07-20 00:00:00",
            "Unnamed: 1": "新辅助",
            "Unnamed: 2": "C1D1",
            "Unnamed: 4": "nab-PTX 0.8  &  OXA 0.7  &  Cado 0.9",
            "Unnamed: 7": "44.5"
        },
        {
            "Unnamed: 0": "2024-08-04 00:00:00",
            "Unnamed: 10": "1.82"
        },
        {
            "Unnamed: 0": "2024-08-09 00:00:00",
            "Unnamed: 1": "新辅助",
            "Unnamed: 2": "C2D1",
            "Unnamed: 3": "C1D21",
            "Unnamed: 4": "nab-PTX 0.8  &  OXA 0.7  & Cado 0.9",
            "Unnamed: 7": "44.5",
            "Unnamed: 12": "1.54",
            "Unnamed: 13": "58.3",
            "Unnamed: 14": "20.9",
            "Unnamed: 16": "19.16",
            "Unnamed: 17": "11.13",
            "Unnamed: 18": "25.7",
            "Unnamed: 19": "0.91"
        },
        {
            "Unnamed: 0": "2024-08-10 00:00:00",
            "Unnamed: 2": "C2D2",
            "Unnamed: 10": "2.22"
        },
        {
            "Unnamed: 0": "2024-08-28 00:00:00",
            "Unnamed: 2": "C2D20",
            "Unnamed: 10": "1.85"
        },
        {
            "Unnamed: 0": "2024-08-30 00:00:00",
            "Unnamed: 1": "新辅助",
            "Unnamed: 2": " C3D1",
            "Unnamed: 3": "C2D22",
            "Unnamed: 4": "nab-PTX 0.9  &  OXA 0.8  & Cado 0.9",
            "Unnamed: 7": "45",
            "Unnamed: 12": "2.47",
            "Unnamed: 13": "54.5",
            "Unnamed: 14": "32.7",
            "Unnamed: 16": "16.77",
            "Unnamed: 17": "9.59",
            "Unnamed: 18": "22.5",
            "Unnamed: 19": "0.91"
        },
        {
            "Unnamed: 0": "2024-09-18 00:00:00",
            "Unnamed: 2": " C3D20",
            "Unnamed: 10": "2.4"
        },
        {
            "Unnamed: 0": "2024-09-19 00:00:00",
            "Unnamed: 1": "新辅助",
            "Unnamed: 2": "C4D1",
            "Unnamed: 3": "C3D21",
            "Unnamed: 4": "nab-PTX 0.9  &  OXA 0.8  & Cado 0.9",
            "Unnamed: 12": "2.11",
            "Unnamed: 13": "58.2",
            "Unnamed: 14": "36",
            "Unnamed: 18": "17.1",
            "Unnamed: 19": "1.02"
        },
        {
            "Unnamed: 0": "2024-09-20 00:00:00",
            "Unnamed: 7": "46"
        },
        {
            "Unnamed: 0": "2024-10-11 00:00:00",
            "Unnamed: 2": "C4D23",
            "Unnamed: 7": "46",
            "Unnamed: 10": "1.25"
        },
        {
            "Unnamed: 0": "2024-10-12 00:00:00",
            "Unnamed: 1": "新辅助",
            "Unnamed: 2": "C5D1",
            "Unnamed: 3": "C4D24",
            "Unnamed: 4": "nab-PTX 0.9  &  OXA 0.8  & Cado 0.9",
            "Unnamed: 12": "2.15",
            "Unnamed: 13": "59.9",
            "Unnamed: 14": "36.6",
            "Unnamed: 16": "13.89",
            "Unnamed: 17": "11.41",
            "Unnamed: 18": "14.2",
            "Unnamed: 19": "1.07"
        },
        {
            "Unnamed: 0": "2024-10-31 00:00:00",
            "Unnamed: 2": "C5D20",
            "Unnamed: 10": "2.86"
        },
        {
            "Unnamed: 0": "2024-11-01 00:00:00",
            "Unnamed: 1": "新辅助",
            "Unnamed: 2": "C6D1",
            "Unnamed: 3": "C5D21",
            "Unnamed: 4": "nab-PTX 1.0  &  OXA 0.8   &  Nivo 1.0",
            "Unnamed: 7": "45",
            "Unnamed: 12": "2.86",
            "Unnamed: 13": "82.4",
            "Unnamed: 14": "44.2",
            "Unnamed: 16": "18.85",
            "Unnamed: 17": "21.45",
            "Unnamed: 18": "15",
            "Unnamed: 19": "1.29"
        },
        {
            "Unnamed: 0": "2024-11-20 00:00:00",
            "Unnamed: 2": "C6D20",
            "Unnamed: 10": "1.78"
        },
        {
            "Unnamed: 0": "2024-11-22 00:00:00",
            "Unnamed: 1": "新辅助",
            "Unnamed: 2": "C7D1",
            "Unnamed: 3": "C6D22",
            "Unnamed: 4": "nab-PTX 1.0  &  OXA 0.8   &  Nivo 1.0",
            "Unnamed: 7": "43",
            "Unnamed: 12": "2.14",
            "Unnamed: 13": "63.3",
            "Unnamed: 14": "45.4",
            "Unnamed: 16": "14.7",
            "Unnamed: 17": "12.79",
            "Unnamed: 18": "14.4",
            "Unnamed: 19": "1.09"
        },
        {
            "Unnamed: 0": "2024-12-11 00:00:00",
            "Unnamed: 2": "C7D20",
            "Unnamed: 10": "2.62"
        },
        {
            "Unnamed: 0": "2024-12-13 00:00:00",
            "Unnamed: 1": "新辅助",
            "Unnamed: 2": "C8D1",
            "Unnamed: 3": "C7D22",
            "Unnamed: 4": "nab-PTX 1.0  &  OXA 0.8   &  Nivo 1.0",
            "Unnamed: 7": "44",
            "Unnamed: 12": "2.18",
            "Unnamed: 13": "76.9",
            "Unnamed: 14": "46.5",
            "Unnamed: 16": "18.12",
            "Unnamed: 17": "18.87",
            "Unnamed: 18": "15.5",
            "Unnamed: 19": "1.2"
        },
        {
            "Unnamed: 0": "2025-01-02 00:00:00",
            "Unnamed: 2": "C8D21",
            "Unnamed: 10": "3.79"
        },
        {
            "Unnamed: 0": "2025-01-15 00:00:00",
            "Unnamed: 1": "胃癌根治术",
            "Unnamed: 2": "AS0",
            "Unnamed: 3": "C8D34",
            "Unnamed: 5": "LRG + D2",
            "Unnamed: 7": "46"
        },
        {
            "Unnamed: 0": "2025-02-01 00:00:00",
            "Unnamed: 2": "AS17",
            "Unnamed: 10": "4.38"
        },
        {
            "Unnamed: 0": "2025-02-15 00:00:00",
            "Unnamed: 2": "AS31",
            "Unnamed: 10": "13.82"
        },
        {
            "Unnamed: 0": "2025-02-19 00:00:00",
            "Unnamed: 2": "AS35",
            "Unnamed: 12": "1.9",
            "Unnamed: 13": "164",
            "Unnamed: 14": "33.7",
            "Unnamed: 16": "60.32",
            "Unnamed: 17": "60.48",
            "Unnamed: 18": "78",
            "Unnamed: 19": "1.29"
        },
        {
            "Unnamed: 0": "2025-02-26 00:00:00",
            "Unnamed: 1": "腹腔镜",
            "Unnamed: 2": "AS42",
            "Unnamed: 5": "Dx lap",
            "Unnamed: 11": "111.96"
        },
        {
            "Unnamed: 0": "2025-02-26 00:00:00",
            "Unnamed: 1": "HEPIC",
            "Unnamed: 2": "AS42",
            "Unnamed: 5": "HEPIC x4",
            "Unnamed: 6": "DTX 60mg & 5-FU 2g"
        },
        {
            "Unnamed: 0": "2025-02-27 00:00:00",
            "Unnamed: 2": "AS43",
            "Unnamed: 6": "DTX 20mg & 5-FU 2g"
        },
        {
            "Unnamed: 0": "2025-02-28 00:00:00",
            "Unnamed: 2": "AS44",
            "Unnamed: 6": "DTX 20mg & 5-FU 2g"
        },
        {
            "Unnamed: 0": "2025-03-01 00:00:00",
            "Unnamed: 2": "AS45",
            "Unnamed: 6": "生理氯化钠3000ml"
        },
        {
            "Unnamed: 0": "2025-03-04 00:00:00",
            "Unnamed: 1": "FDA 505b",
            "Unnamed: 2": "AS48",
            "Unnamed: 5": "MBZ x6 cont."
        },
        {
            "Unnamed: 0": "2025-03-12 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C1D1",
            "Unnamed: 3": "AS56",
            "Unnamed: 4": "nab-PTX 1.0 & Nivo 1.0 & CF 1.0 & 5-FU 1.0",
            "Unnamed: 12": "3.06",
            "Unnamed: 13": "136",
            "Unnamed: 14": "37",
            "Unnamed: 16": "45.82",
            "Unnamed: 17": "48.74",
            "Unnamed: 18": "45.2",
            "Unnamed: 19": "3.63"
        },
        {
            "Unnamed: 0": "2025-03-14 00:00:00",
            "Unnamed: 7": "40"
        },
        {
            "Unnamed: 0": "2025-03-27 00:00:00",
            "Unnamed: 2": "C1D16",
            "Unnamed: 12": "2.32",
            "Unnamed: 13": "106",
            "Unnamed: 14": "46.8",
            "Unnamed: 16": "43.77",
            "Unnamed: 17": "34.89",
            "Unnamed: 18": "57.6",
            "Unnamed: 19": "3.68"
        },
        {
            "Unnamed: 0": "2025-03-28 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C2D1",
            "Unnamed: 3": "C1D17",
            "Unnamed: 4": "nab-PTX 1.0 & Nivo 1.0 & CF 1.0 & 5-FU 1.0"
        },
        {
            "Unnamed: 0": "2025-03-30 00:00:00",
            "Unnamed: 7": "37.5"
        },
        {
            "Unnamed: 0": "2025-04-11 00:00:00",
            "Unnamed: 2": "C2D15",
            "Unnamed: 7": "37.5",
            "Unnamed: 12": "6.05",
            "Unnamed: 13": "123",
            "Unnamed: 14": "35.7",
            "Unnamed: 16": "31.8",
            "Unnamed: 17": "41.83",
            "Unnamed: 18": "22.6",
            "Unnamed: 19": "3.03"
        },
        {
            "Unnamed: 0": "2025-04-12 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C3D1",
            "Unnamed: 3": "C2D16",
            "Unnamed: 4": "nab-PTX 1.0 & Nivo 1.0 & CF 1.0 & 5-FU 1.0"
        },
        {
            "Unnamed: 0": "2025-04-24 00:00:00",
            "Unnamed: 2": "C3D13",
            "Unnamed: 7": "38.5",
            "Unnamed: 12": "6.32",
            "Unnamed: 13": "89.32",
            "Unnamed: 14": "25.35",
            "Unnamed: 16": "17.35",
            "Unnamed: 17": "27.76",
            "Unnamed: 18": "11.44",
            "Unnamed: 19": "4.28"
        },
        {
            "Unnamed: 0": "2025-04-25 00:00:00",
            "Unnamed: 2": "C3D14",
            "Unnamed: 10": "0.2"
        },
        {
            "Unnamed: 0": "2025-04-26 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C4D1",
            "Unnamed: 3": "C3D15",
            "Unnamed: 4": "nab-PTX 1.0 & Nivo 1.0 & CF 1.0 & 5-FU 1.0"
        },
        {
            "Unnamed: 0": "2025-05-10 00:00:00",
            "Unnamed: 2": "C4D15",
            "Unnamed: 5": "MBZ x6 dis.",
            "Unnamed: 6": "因肝功能轻度异常，停服MBZ至2025-06-12，均非医嘱"
        },
        {
            "Unnamed: 0": "2025-05-12 00:00:00",
            "Unnamed: 2": "C4D17",
            "Unnamed: 12": "4.35",
            "Unnamed: 13": "278.87",
            "Unnamed: 14": "27.39",
            "Unnamed: 16": "41.72",
            "Unnamed: 17": "100.19",
            "Unnamed: 18": "12.33",
            "Unnamed: 19": "3.64"
        },
        {
            "Unnamed: 0": "2025-05-13 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C5D1",
            "Unnamed: 3": "C4D18",
            "Unnamed: 4": "nab-PTX 1.0 & CF 1.0 & 5-FU 1.0"
        },
        {
            "Unnamed: 0": "2025-05-29 00:00:00",
            "Unnamed: 2": "C5D17",
            "Unnamed: 7": "38.7",
            "Unnamed: 12": "7.23",
            "Unnamed: 13": "143.29",
            "Unnamed: 14": "23",
            "Unnamed: 16": "27.11",
            "Unnamed: 17": "57.81",
            "Unnamed: 18": "12.97",
            "Unnamed: 19": "4.28"
        },
        {
            "Unnamed: 0": "2025-05-30 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C6D1",
            "Unnamed: 3": "C5D18",
            "Unnamed: 4": "nab-PTX 1.0 & Nivo 1.0 & CF 1.0 & 5-FU 1.0"
        },
        {
            "Unnamed: 0": "2025-06-11 00:00:00",
            "Unnamed: 2": "C6D13",
            "Unnamed: 7": "37.5"
        },
        {
            "Unnamed: 0": "2025-06-12 00:00:00",
            "Unnamed: 1": "FDA505b",
            "Unnamed: 2": "C6D14",
            "Unnamed: 5": "MBZ x6 cont.",
            "Unnamed: 6": "启动MBZ 600mg/d PO bid，continuous非医嘱",
            "Unnamed: 10": "0.16",
            "Unnamed: 12": "10.65",
            "Unnamed: 13": "136.4",
            "Unnamed: 14": "24.07",
            "Unnamed: 16": "27.72",
            "Unnamed: 17": "54.1",
            "Unnamed: 18": "14.62",
            "Unnamed: 19": "1.69"
        },
        {
            "Unnamed: 0": "2025-06-13 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C7D1",
            "Unnamed: 3": "C6D15",
            "Unnamed: 4": "nab-PTX 1.0 & Nivo 1.0 & CF 1.0 & 5-FU 1.0"
        },
        {
            "Unnamed: 0": "2025-06-29 00:00:00",
            "Unnamed: 1": "FDA505b",
            "Unnamed: 2": "C7D17",
            "Unnamed: 5": "MBZ x9 cont.",
            "Unnamed: 6": "启动MBZ 900mg/d PO tid，continuous 非医嘱",
            "Unnamed: 7": "37.2",
            "Unnamed: 12": "12.41",
            "Unnamed: 13": "129.27",
            "Unnamed: 14": "29.1",
            "Unnamed: 16": "30.06",
            "Unnamed: 17": "50.01",
            "Unnamed: 18": "18.68",
            "Unnamed: 19": "2.86"
        },
        {
            "Unnamed: 0": "2025-06-30 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C8D1",
            "Unnamed: 3": "C7D18",
            "Unnamed: 4": "nab-PTX 1.0 & CF 1.0 & 5-FU 1.0"
        },
        {
            "Unnamed: 0": "2025-07-12 00:00:00",
            "Unnamed: 2": "C8D13",
            "Unnamed: 10": "0.37"
        },
        {
            "Unnamed: 0": "2025-07-19 00:00:00",
            "Unnamed: 2": "C8D20",
            "Unnamed: 7": "37.9",
            "Unnamed: 12": "8.03",
            "Unnamed: 13": "101.23",
            "Unnamed: 14": "24.6",
            "Unnamed: 16": "27.79",
            "Unnamed: 17": "34.23",
            "Unnamed: 18": "22.89",
            "Unnamed: 19": "4.56"
        },
        {
            "Unnamed: 0": "2025-07-21 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C9D1",
            "Unnamed: 3": "C8D22",
            "Unnamed: 4": "nab-PTX 1.0 & Nivo 1.0 & CF 1.0 & 5-FU 1.0"
        },
        {
            "Unnamed: 0": "2025-08-20 00:00:00",
            "Unnamed: 7": "37"
        },
        {
            "Unnamed: 0": "2025-08-22 00:00:00",
            "Unnamed: 2": "C9D33",
            "Unnamed: 10": "1.9"
        },
        {
            "Unnamed: 0": "2025-08-30 00:00:00",
            "Unnamed: 7": "36"
        },
        {
            "Unnamed: 0": "2025-09-03 00:00:00",
            "Unnamed: 2": "C9D45",
            "Unnamed: 12": "8.18",
            "Unnamed: 14": "42.07",
            "Unnamed: 18": "32.75",
            "Unnamed: 19": "1.31"
        },
        {
            "Unnamed: 0": "2025-09-04 00:00:00",
            "Unnamed: 7": "35.9"
        },
        {
            "Unnamed: 0": "2025-09-19 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C10D1",
            "Unnamed: 3": "C9D61",
            "Unnamed: 4": "Sac-TMT 1.0",
            "Unnamed: 7": "37.5",
            "Unnamed: 10": "15.91"
        },
        {
            "Unnamed: 0": "2025-09-20 00:00:00",
            "Unnamed: 2": "C10D22",
            "Unnamed: 5": "MBZ x9 dis.",
            "Unnamed: 6": "因TROP2后容易呕吐，停服MBZ至2025-09-30，非医嘱"
        },
        {
            "Unnamed: 0": "2025-09-25 00:00:00",
            "Unnamed: 2": "C10D7",
            "Unnamed: 11": "28.93"
        },
        {
            "Unnamed: 0": "2025-09-26 00:00:00",
            "Unnamed: 2": "C10D8",
            "Unnamed: 10": "15.74"
        },
        {
            "Unnamed: 0": "2025-09-30 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C10D12",
            "Unnamed: 4": "Nivo 1.0"
        },
        {
            "Unnamed: 0": "2025-10-01 00:00:00",
            "Unnamed: 1": "FDA505b",
            "Unnamed: 2": "C10D13",
            "Unnamed: 5": "MBZ x6 cont.",
            "Unnamed: 6": "启动MBZ 600mg/d PO bid，continuous非医嘱"
        },
        {
            "Unnamed: 0": "2025-10-04 00:00:00",
            "Unnamed: 7": "36"
        },
        {
            "Unnamed: 0": "2025-10-07 00:00:00",
            "Unnamed: 8": "18.7"
        },
        {
            "Unnamed: 0": "2025-10-10 00:00:00",
            "Unnamed: 2": "C10D22",
            "Unnamed: 7": "36",
            "Unnamed: 10": "71.12",
            "Unnamed: 12": "9.03",
            "Unnamed: 13": "112.42",
            "Unnamed: 14": "41.62",
            "Unnamed: 16": "57.2",
            "Unnamed: 17": "39.09",
            "Unnamed: 18": "111.89",
            "Unnamed: 19": "1.78"
        },
        {
            "Unnamed: 0": "2025-10-11 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C11D1",
            "Unnamed: 3": "C10D23",
            "Unnamed: 4": "Sac-TMT 1.0 & 5-FU 1.0 & Na-LV1.0"
        },
        {
            "Unnamed: 0": "2025-10-18 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C11D8",
            "Unnamed: 4": "Nivo 1.0"
        },
        {
            "Unnamed: 0": "2025-10-24 00:00:00",
            "Unnamed: 2": "C11D14",
            "Unnamed: 7": "35.5",
            "Unnamed: 8": "21",
            "Unnamed: 10": "13.37"
        },
        {
            "Unnamed: 0": "2025-10-25 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C12D1",
            "Unnamed: 3": "C11D15",
            "Unnamed: 4": "Sac-TMT 1.0 & 5-FU 1.0 &  Na-LV1.0"
        },
        {
            "Unnamed: 0": "2025-10-25 00:00:00",
            "Unnamed: 2": "C12D1",
            "Unnamed: 6": "启动服用醋酸甲地孕酮 5ml/d PO qd continuous",
            "Unnamed: 12": "10.23",
            "Unnamed: 13": "95.54",
            "Unnamed: 14": "56.01",
            "Unnamed: 16": "47.47",
            "Unnamed: 17": "30.29",
            "Unnamed: 18": "82.15",
            "Unnamed: 19": "2.93"
        },
        {
            "Unnamed: 0": "2025-10-28 00:00:00",
            "Unnamed: 2": "C12D4",
            "Unnamed: 5": "MBZ x6 dis.",
            "Unnamed: 6": "因吃太多药心烦，停服MBZ，非医嘱"
        },
        {
            "Unnamed: 0": "2025-10-31 00:00:00",
            "Unnamed: 1": "辅助",
            "Unnamed: 2": "C12D7",
            "Unnamed: 3": "C12D07",
            "Unnamed: 4": "Nivo 1.0"
        },
        {
            "Unnamed: 0": "2025-11-13 00:00:00",
            "Unnamed: 7": "36.55",
            "Unnamed: 8": "18.95"
        },
        {
            "Unnamed: 0": "2025-11-19 00:00:00",
            "Unnamed: 2": "C12D29",
            "Unnamed: 5": "Tα1 BIW cont."
        },
        {
            "Unnamed: 0": "2025-11-23 00:00:00",
            "Unnamed: 2": "C12D33",
            "Unnamed: 12": "5.86",
            "Unnamed: 14": "82.93",
            "Unnamed: 15": "2.22"
        },
        {
            "Unnamed: 0": "2025-11-24 00:00:00",
            "Unnamed: 2": "C12D34",
            "Unnamed: 13": "99.9",
            "Unnamed: 18": "45.61"
        }
    ]
};

        const AppState = {
            data: { phases: [], events: [], metrics: {}, schemes: [], totalPoints: 0 },
            view: { showPhases: true, showEvents: true, showSchemes: false, phaseOpacity: 0.15, margin: { top: 85, right: 30, bottom: 30, left: 30 }, width: 0, height: 0, chartFlexRatio: 2, isPrinting: false },
            colors: ['#0284c7', '#d97706', '#be185d', '#7c3aed', '#059669', '#dc2626', '#475569', '#4f46e5', '#ea580c', '#0d9488', '#c026d3', '#6366f1', '#84cc16', '#f43f5e']
        };

        function processData() {
            const rootKey = Object.keys(sourceData)[0];
            const patientName = rootKey.replace(/医疗项目|项目/g, '').trim();
            const titleEl = document.getElementById('chart-title');
            if (titleEl) titleEl.querySelector('h2').innerText = `Timeline of Cancer Treatment and Monitoring in Patient ${patientName}`;
            const dataset = sourceData[rootKey];
            const headerRow = dataset[3];
            const unitRow = dataset[4];
            const COL_DATE = "Unnamed: 0", COL_PHASE = "Unnamed: 1", COL_CYCLE = "Unnamed: 2", COL_SCHEME = "Unnamed: 4", COL_EVENT = "Unnamed: 5";

            const metricMap = {};
            Object.entries(headerRow).forEach(([key, val]) => {
                // Fix #13: Parse all "Unnamed" columns for MRD (removed "Unnamed: 2", "Unnamed: 6" from exclusion)
                if (val && ![COL_DATE, COL_PHASE, COL_CYCLE, COL_EVENT, COL_SCHEME].includes(key)) {
                    metricMap[key] = val;
                    if (!AppState.data.metrics[val]) {
                        const colorIdx = Object.keys(AppState.data.metrics).length % AppState.colors.length;

                        let threshold = null;
                        if (unitRow[key] && typeof unitRow[key] === 'string') {
                            const match = unitRow[key].match(/[<>]\s*([\d\.]+)/);
                            if (match) threshold = parseFloat(match[1]);
                        }

                        AppState.data.metrics[val] = {
                            id: key, name: val, data: [], color: AppState.colors[colorIdx],
                            scale: 1.0, offset: 0, opacity: 1.0, showLine: true, showValues: false, mid: 0, // NEW PROPS
                            active: false, expanded: false,
                            unit: unitRow[key] || '', rangeMin: 0, rangeMax: 0, threshold: threshold
                        };
                    }
                }
            });

            let dataPointCount = 0;
            let alertCount = 0;
            const timeline = [];
            dataset.slice(5).forEach(row => {
                const dateStr = row[COL_DATE];
                if (!dateStr || typeof dateStr !== 'string') return;
                const date = new Date(dateStr);
                if (isNaN(date)) return;
                timeline.push({ date, row });
                if (row[COL_EVENT]) AppState.data.events.push({ date, name: row[COL_EVENT] });

                Object.keys(metricMap).forEach(key => {
                    let rawVal = row[key];
                    if (rawVal != null && rawVal !== "") {
                        if (typeof rawVal === 'string') rawVal = rawVal.replace(/,/g, '').replace(/[<>]/g, '');
                        const num = parseFloat(rawVal);
                        if (!isNaN(num)) {
                            const metric = AppState.data.metrics[metricMap[key]];
                            const isAlert = (metric.threshold !== null && num > metric.threshold);
                            if (isAlert) alertCount++;
                            metric.data.push({ date, value: num, isAlert });
                            dataPointCount++;
                        }
                    }
                });
            });

            Object.values(AppState.data.metrics).forEach(m => {
                if (m.data.length === 0) return;
                const vals = m.data.map(d => d.value);
                const min = Math.min(...vals), max = Math.max(...vals);
                m.rangeMin = min; m.rangeMax = max;
                m.mid = (min + max) / 2;

                if (max === min) {
                    m.scale = 1;
                    m.offset = 50 - m.mid;
                } else {
                    m.scale = 60 / (max - min);
                    m.offset = 50 - m.mid;
                }
                m.scale = parseFloat(m.scale.toFixed(3)); m.offset = Math.round(m.offset);
            });

            let currentPhase = null;
            timeline.sort((a, b) => a.date - b.date);
            timeline.forEach(({ date, row }) => {
                const phaseName = row[COL_PHASE], cycleName = row[COL_CYCLE] ? (row[COL_CYCLE].match(/C\d+/) || [row[COL_CYCLE]])[0] : null, schemeText = row[COL_SCHEME];
                const eventName = row[COL_EVENT];
                // Fix: Only start new phase if cycle changes or if it's a non-cycle phase start
                // Refinement: Do not interrupt an active cycle (e.g. C0) with a non-cycle phase unless it is Surgery ("术")
                const isNewCycle = cycleName && (!currentPhase || currentPhase.cycle !== cycleName);
                const isNewNonCyclePhase = !cycleName && phaseName && phaseName !== eventName &&
                    (!currentPhase || !currentPhase.cycle || phaseName.includes("术"));

                if (isNewCycle || isNewNonCyclePhase) {
                    if (currentPhase) {
                        currentPhase.end = date;
                        currentPhase.duration = Math.ceil((currentPhase.end - currentPhase.start) / (1000 * 60 * 60 * 24));
                        AppState.data.phases.push(currentPhase);
                    }
                    currentPhase = { start: date, end: null, name: phaseName || (currentPhase ? currentPhase.name : "Treatment"), cycle: cycleName || "", scheme: schemeText || (currentPhase ? currentPhase.scheme : ""), type: (phaseName && phaseName.includes("术")) ? "surgery" : "medication" };
                } else if (schemeText && currentPhase) { currentPhase.scheme = schemeText; }
            });
            // Calculate maxDate from all data points to ensure last phase covers everything
            let maxDate = new Date(timeline[0].date);
            timeline.forEach(t => {
                if (t.date > maxDate) maxDate = t.date;
            });

            if (currentPhase) {
                const defaultEnd = new Date(currentPhase.start.getTime() + (21 * 24 * 60 * 60 * 1000));
                // Extend to cover maxDate if it's later than the default 21-day cycle
                currentPhase.end = new Date(Math.max(defaultEnd.getTime(), maxDate.getTime()));
                currentPhase.duration = Math.ceil((currentPhase.end - currentPhase.start) / (1000 * 60 * 60 * 24));
                AppState.data.phases.push(currentPhase);
            }

            // Default activation moved to main initialization block

            // Sort events and assign overlap indices for collision handling
            AppState.data.events.sort((a, b) => a.date - b.date);
            let lastDate = null;
            let overlapCount = 0;
            AppState.data.events.forEach(e => {
                if (lastDate && e.date.getTime() === lastDate.getTime()) {
                    overlapCount++;
                } else {
                    overlapCount = 0;
                    lastDate = e.date;
                }
                e.overlapIndex = overlapCount;
            });


            AppState.data.totalPoints = dataPointCount;
            const dateExtent = d3.extent(timeline, d => d.date);
            if (dateExtent[0]) document.getElementById('kpi-range').innerText = `${d3.timeFormat("%y-%m-%d")(dateExtent[0])} → ${d3.timeFormat("%y-%m-%d")(dateExtent[1])}`;
            document.getElementById('kpi-points').innerText = dataPointCount;
            document.getElementById('kpi-alerts').innerText = alertCount;
        }

        function renderControls() {
            const container = document.getElementById('metric-controls-container');
            const legend = document.getElementById('active-legend');
            container.innerHTML = ''; legend.innerHTML = '';

            Object.values(AppState.data.metrics).sort((a, b) => b.data.length - a.data.length).forEach(m => {
                if (m.data.length === 0) return;
                const scaleStep = m.scale < 0.1 ? 0.001 : 0.1, scaleMax = m.scale * 5;
                const item = document.createElement('div');
                const baseCls = "expand-transition group rounded cursor-pointer select-none overflow-hidden relative border shadow-sm flex flex-col";
                const collapsedCls = "bg-white border-slate-200 hover:border-blue-300 py-2 px-3";
                const expandedCls = "bg-slate-50 border-slate-400 shadow-md py-3 px-3 border-l-[4px]";
                item.className = `${baseCls} ${m.expanded ? expandedCls : collapsedCls}`;
                item.style.borderLeftColor = m.expanded ? m.color : 'transparent';
                item.onclick = (e) => { if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.closest('button')) return; toggleExpansion(m.name); };

                item.innerHTML = `
                    <div class="flex items-center justify-between gap-2">
                        <div class="flex items-center gap-2 overflow-hidden flex-1">
                            <input type="checkbox" class="custom-checkbox w-4 h-4 rounded-sm text-blue-600 bg-slate-100 border-slate-300 focus:ring-0 cursor-pointer shrink-0" ${m.active ? 'checked' : ''} onclick="event.stopPropagation(); toggleMetric('${m.name}')">
                            <div class="w-1 h-4 rounded-full shrink-0" style="background-color: ${m.color}; opacity: ${m.opacity}"></div>
                            <div class="flex flex-col overflow-hidden">
                                <div class="flex items-baseline gap-1">
                                    <span class="text-[11px] font-bold ${m.active ? 'text-slate-900' : 'text-slate-500'} truncate">${m.name}</span>
                                    ${!m.expanded ? `<span class="text-[9px] text-slate-400 truncate">(${m.unit})</span>` : ''}
                                </div>
                                ${m.expanded ? `<span class="text-[9px] text-slate-500 font-mono leading-none">${m.data.length}pts [${m.rangeMin}-${m.rangeMax}]</span>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-1 shrink-0">
                            ${m.expanded ? `<input type="color" value="${m.color}" class="w-5 h-5 bg-transparent border-none cursor-pointer rounded" onclick="event.stopPropagation()" onchange="updateColor('${m.name}', this.value)">` : ''}
                            <i class="fa-solid fa-chevron-down text-[10px] text-slate-400 transition-transform duration-300 ${m.expanded ? 'rotate-180' : ''}"></i>
                        </div>
                    </div>
                    ${m.expanded ? `
                        <div class="mt-2 pt-2 border-t border-slate-200 grid grid-cols-2 gap-x-3 gap-y-2 cursor-default" onclick="event.stopPropagation()">
                            
                            <!-- Row 1: Scale & Shift -->
                            <div class="touch-none"><div class="flex justify-between text-[9px] text-slate-500 mb-1"><span>Scale</span><span>${m.scale}</span></div><input type="range" min="0.001" max="${scaleMax}" step="${scaleStep}" value="${m.scale}" class="w-full h-1 bg-slate-300 rounded-lg appearance-none accent-blue-600" oninput="updateScale('${m.name}', this.value, this.previousElementSibling)"></div>
                            <div class="touch-none"><div class="flex justify-between text-[9px] text-slate-500 mb-1"><span>Shift</span><span>${m.offset}</span></div><input type="range" min="-200" max="200" step="1" value="${m.offset}" class="w-full h-1 bg-slate-300 rounded-lg appearance-none accent-blue-600" oninput="updateOffset('${m.name}', this.value, this.previousElementSibling)"></div>
                            
                            <!-- Row 2: Opacity & Line Toggle -->
                            <div class="touch-none"><div class="flex justify-between text-[9px] text-slate-500 mb-1"><span>Opacity</span><span>${m.opacity}</span></div><input type="range" min="0.1" max="1" step="0.1" value="${m.opacity}" class="w-full h-1 bg-slate-300 rounded-lg appearance-none accent-blue-600" oninput="updateOpacity('${m.name}', this.value, this.previousElementSibling)"></div>
                            <div class="flex items-end justify-end gap-1">
                                <button onclick="toggleLine('${m.name}')" class="flex items-center gap-1 text-[10px] bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded border border-slate-300 transition-colors ${!m.showLine ? 'text-slate-400' : 'text-blue-600 font-bold'}">
                                    <i class="fa-solid ${m.showLine ? 'fa-chart-line' : 'fa-ellipsis'}"></i> ${m.showLine ? 'Line' : 'Dots'}
                                </button>
                                <button onclick="toggleValues('${m.name}')" class="flex items-center gap-1 text-[10px] bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded border border-slate-300 transition-colors ${!m.showValues ? 'text-slate-400' : 'text-emerald-600 font-bold'}">
                                    <i class="fa-solid fa-hashtag"></i> ${m.showValues ? '隐藏数值' : '显示数值'}
                                </button>
                            </div>
                        </div>` : ''}
                `;
                container.appendChild(item);

                if (m.active) {
                    const badge = document.createElement('div');
                    badge.className = "flex items-center gap-1 px-1 py-0.5 text-[10px] text-slate-500 whitespace-nowrap cursor-pointer hover:text-slate-900 transition-colors";
                    badge.onclick = () => toggleExpansion(m.name);
                    // Legend Style: —●— Name
                    badge.innerHTML = `
                        <div class="flex items-center relative w-6 justify-center">
                            <div class="absolute w-full h-0.5" style="background-color:${m.color}; opacity:0.6"></div>
                            <div class="w-2 h-2 rounded-full z-10 border border-white" style="background-color:${m.color}; opacity:${m.opacity}"></div>
                        </div>
                        <span class="font-bold text-slate-600">${m.name}</span>
                    `;
                    legend.appendChild(badge);
                }
            });
        }

        function toggleExpansion(name) { AppState.data.metrics[name].expanded = !AppState.data.metrics[name].expanded; saveSettings(); renderControls(); }
        function toggleMetric(name) { AppState.data.metrics[name].active = !AppState.data.metrics[name].active; saveSettings(); renderControls(); drawChart(false); }

        function updateScale(n, v, el) { AppState.data.metrics[n].scale = parseFloat(v); if (el) el.lastElementChild.innerText = v; saveSettings(); drawChart(false); }
        function updateOffset(n, v, el) { AppState.data.metrics[n].offset = parseFloat(v); if (el) el.lastElementChild.innerText = v; saveSettings(); drawChart(false); }
        function updateOpacity(n, v, el) { AppState.data.metrics[n].opacity = parseFloat(v); if (el) el.lastElementChild.innerText = v; saveSettings(); drawChart(false); renderControls(); }
        function toggleLine(n) { AppState.data.metrics[n].showLine = !AppState.data.metrics[n].showLine; saveSettings(); renderControls(); drawChart(false); }
        function toggleValues(n) { AppState.data.metrics[n].showValues = !AppState.data.metrics[n].showValues; saveSettings(); renderControls(); drawChart(false); }
        function updateColor(n, v) { AppState.data.metrics[n].color = v; saveSettings(); renderControls(); drawChart(false); }
        function updatePhaseOpacity(v) { AppState.view.phaseOpacity = parseFloat(v); saveSettings(); drawChart(false); }

        let svg, gMain, x, y, zoom;
        function initChart() {
            const container = document.getElementById('chart-container');
            if (AppState.view.isPrinting) {
                // Force A4 Landscape dimensions (approx 297mm x 210mm @ 96dpi)
                AppState.view.width = 1122;
                AppState.view.height = 793;
            } else {
                AppState.view.width = container.clientWidth;
                AppState.view.height = container.clientHeight;
            }
            d3.select(container).selectAll("*").remove();

            svg = d3.select(container).append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", [0, 0, AppState.view.width, AppState.view.height]).style("touch-action", "none");
            const defs = svg.append("defs");

            // Arrow Markers for Year Axis
            defs.append("marker")
                .attr("id", "arrow-start")
                .attr("viewBox", "0 0 10 10")
                .attr("refX", 10) // Tip at the right (pointing left)
                .attr("refY", 5)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M 10 0 L 0 5 L 10 10 z") // Pointing Left
                .attr("fill", "#94a3b8");

            defs.append("marker")
                .attr("id", "arrow-end")
                .attr("viewBox", "0 0 10 10")
                .attr("refX", 0) // Tip at the left (pointing right)
                .attr("refY", 5)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M 0 0 L 10 5 L 0 10 z") // Pointing Right
                .attr("fill", "#94a3b8");

            defs.append("clipPath").attr("id", "mainClip").append("rect")
                .attr("x", AppState.view.margin.left)
                .attr("y", 0) // Allow drawing in header area (for phase backgrounds)
                .attr("width", Math.max(0, AppState.view.width - AppState.view.margin.left - AppState.view.margin.right))
                .attr("height", Math.max(0, AppState.view.height - AppState.view.margin.bottom)); // Full height minus bottom

            // NEW: Chart Clip (Strictly for data points/lines, excluding header)
            defs.append("clipPath").attr("id", "chartClip").append("rect")
                .attr("x", AppState.view.margin.left)
                .attr("y", AppState.view.margin.top)
                .attr("width", Math.max(0, AppState.view.width - AppState.view.margin.left - AppState.view.margin.right))
                .attr("height", Math.max(0, AppState.view.height - AppState.view.margin.top - AppState.view.margin.bottom));

            const allDates = [...AppState.data.phases.map(p => p.start), ...AppState.data.phases.map(p => p.end), ...AppState.data.events.map(e => e.date)].filter(d => d);
            const domain = d3.extent(allDates);
            if (domain[0]) domain[0] = new Date(domain[0].getTime() - 864000000);
            if (domain[1]) domain[1] = new Date(domain[1].getTime() + 864000000);

            x = d3.scaleTime().domain(domain).range([AppState.view.margin.left, AppState.view.width - AppState.view.margin.right]);
            y = d3.scaleLinear().domain([0, 100]).range([AppState.view.height - AppState.view.margin.bottom, AppState.view.margin.top]);

            zoom = d3.zoom()
                .scaleExtent([0.5, 20])
                .translateExtent([[-2000, 0], [AppState.view.width + 2000, AppState.view.height]])
                .filter(event => !event.type.includes('wheel')) // Disable scroll zoom
                .on("zoom", (e) => {
                    const newX = e.transform.rescaleX(x);
                    updateChart(newX);
                    gMain.select(".x-axis-month").call(d3.axisBottom(newX).ticks(d3.timeMonth.every(1)).tickFormat(d3.timeFormat("%m")).tickSizeOuter(0));
                    gMain.select(".x-axis-year").call(d3.axisBottom(newX).ticks(d3.timeYear.every(1)).tickFormat(d3.timeFormat("%Y")).tickSize(0).tickPadding(0)).select(".domain").remove();
                });

            svg.call(zoom).on("dblclick.zoom", null);
            gMain = svg.append("g");

            // Header Background
            gMain.append("rect")
                .attr("class", "header-bg")
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", AppState.view.width)
                .attr("height", AppState.view.margin.top)
                .attr("fill", "#f1f5f9"); // Slate-100

            // Header Separator Line
            gMain.append("line")
                .attr("class", "header-separator")
                .attr("x1", 0)
                .attr("y1", AppState.view.margin.top)
                .attr("x2", AppState.view.width)
                .attr("y2", AppState.view.margin.top)
                .attr("stroke", "#cbd5e1") // Slate-300
                .attr("stroke-width", 1);

            // Custom Date Axis: Month/Day ticks
            gMain.append("g").attr("class", "x-axis-month").attr("transform", `translate(0,${AppState.view.height - AppState.view.margin.bottom})`)
                .call(d3.axisBottom(x).ticks(d3.timeMonth.every(1)).tickFormat(d3.timeFormat("%m")).tickSizeOuter(0));

            // Custom Date Axis: Mid-month ticks (No labels)
            gMain.append("g").attr("class", "x-axis-minor").attr("transform", `translate(0,${AppState.view.height - AppState.view.margin.bottom})`)
                .call(d3.axisBottom(x).ticks(d3.timeDay.filter(d => d.getDate() === 15)).tickFormat("").tickSize(4).tickSizeOuter(0));

            // Custom Date Axis: Year labels (Custom Container)
            gMain.append("g").attr("class", "x-axis-year-custom").attr("transform", `translate(0,${AppState.view.height - AppState.view.margin.bottom + 20})`);

            gMain.append("g").attr("class", "y-axis").attr("transform", `translate(${AppState.view.margin.left},0)`).call(d3.axisLeft(y));

            // Content Layer with Sub-layers for Z-indexing
            const contentLayer = gMain.append("g").attr("id", "content-layer").attr("clip-path", "url(#mainClip)");
            contentLayer.append("g").attr("id", "phase-layer");
            // Apply chartClip to data layers
            contentLayer.append("g").attr("id", "line-layer").attr("clip-path", "url(#chartClip)");
            contentLayer.append("g").attr("id", "dot-layer").attr("clip-path", "url(#chartClip)");
            contentLayer.append("g").attr("id", "label-layer").attr("clip-path", "url(#chartClip)");

            gMain.append("g").attr("id", "event-layer"); // Unclipped layer for events
            updateChart(x);
        }

        function zoomChart(factor) { if (svg && zoom) svg.transition().duration(300).call(zoom.scaleBy, factor); }
        function resetChartZoom() { if (svg && zoom) svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity); }

        function zoomYAxis(factor) {
            AppState.view.chartFlexRatio *= factor;
            AppState.view.chartFlexRatio = Math.max(0.5, Math.min(10, AppState.view.chartFlexRatio));
            updateChartHeight();
        }

        function autoFitYAxis() {
            AppState.view.chartFlexRatio = 2;
            updateChartHeight();
        }

        function updateChartHeight() {
            const chartPane = document.getElementById('chart-pane');
            if (chartPane) {
                chartPane.style.flex = AppState.view.chartFlexRatio.toString();
                // Redraw chart with new dimensions
                setTimeout(() => drawChart(true), 50);
            }
        }

        function updateChart(scaleX) {
            // Update Axes
            gMain.select(".x-axis-month").call(d3.axisBottom(scaleX).ticks(d3.timeMonth.every(1)).tickFormat(d3.timeFormat("%m")).tickSizeOuter(0));
            gMain.select(".x-axis-minor").call(d3.axisBottom(scaleX).ticks(d3.timeDay.filter(d => d.getDate() === 15)).tickFormat("").tickSize(4).tickSizeOuter(0));
            gMain.select(".x-axis-month").call(d3.axisBottom(scaleX).ticks(d3.timeMonth.every(1)).tickFormat(d3.timeFormat("%m")).tickSizeOuter(0));
            gMain.select(".x-axis-minor").call(d3.axisBottom(scaleX).ticks(d3.timeDay.filter(d => d.getDate() === 15)).tickFormat("").tickSize(4).tickSizeOuter(0));

            // --- Custom Year Bracket Axis ---
            const yearGroup = gMain.select(".x-axis-year-custom");
            yearGroup.selectAll("*").remove();

            const domainStart = scaleX.domain()[0];
            const domainEnd = scaleX.domain()[1];
            const years = d3.timeYear.range(d3.timeYear.floor(domainStart), d3.timeYear.ceil(domainEnd));
            // Add the last year boundary if not included
            if (years[years.length - 1] < domainEnd) {
                years.push(d3.timeYear.offset(years[years.length - 1], 1));
            }

            years.forEach(yearDate => {
                const nextYearDate = d3.timeYear.offset(yearDate, 1);
                const yearStart = yearDate < domainStart ? domainStart : yearDate;
                const yearEnd = nextYearDate > domainEnd ? domainEnd : nextYearDate;

                if (yearStart < yearEnd) {
                    const x1 = scaleX(yearStart);
                    const x2 = scaleX(yearEnd);
                    const width = x2 - x1;

                    if (width > 20) { // Only draw if wide enough
                        const mid = (x1 + x2) / 2;
                        const yearLabel = d3.timeFormat("%Y")(yearDate);

                        // 1. Year Text
                        yearGroup.append("text")
                            .attr("x", mid)
                            .attr("y", 4)
                            .attr("text-anchor", "middle")
                            .attr("fill", "#64748b") // Slate-500
                            .attr("font-size", "11px")
                            .attr("font-weight", "bold")
                            .text(yearLabel);

                        // 2. Left Arrow Line (if space permits)
                        if (mid - x1 > 30) {
                            yearGroup.append("line")
                                .attr("x1", x1 + 5)
                                .attr("y1", 0)
                                .attr("x2", mid - 20)
                                .attr("y2", 0)
                                .attr("stroke", "#94a3b8")
                                .attr("stroke-width", 1.5)
                                .attr("marker-start", "url(#arrow-start)");
                        }

                        // 3. Right Arrow Line (if space permits)
                        if (x2 - mid > 30) {
                            yearGroup.append("line")
                                .attr("x1", mid + 20)
                                .attr("y1", 0)
                                .attr("x2", x2 - 5)
                                .attr("y2", 0)
                                .attr("stroke", "#94a3b8")
                                .attr("stroke-width", 1.5)
                                .attr("marker-end", "url(#arrow-end)");
                        }
                    }
                }

                // 4. Vertical Separator at Year Start (Jan 1)
                // Only draw if it's within the visible chart area (with some tolerance)
                const boundaryX = scaleX(yearDate);
                if (boundaryX >= 0 && boundaryX <= AppState.view.width) {
                    yearGroup.append("line")
                        .attr("x1", boundaryX)
                        .attr("y1", -15) // Extend up slightly towards month axis
                        .attr("x2", boundaryX)
                        .attr("y2", 10)
                        .attr("stroke", "#cbd5e1") // Slate-300
                        .attr("stroke-width", 2);
                }
            });

            const layer = gMain.select("#content-layer");
            const phaseLayer = layer.select("#phase-layer");
            const lineLayer = layer.select("#line-layer");
            const dotLayer = layer.select("#dot-layer");
            const labelLayer = layer.select("#label-layer");

            phaseLayer.selectAll(".phase-group").remove();
            lineLayer.selectAll("*").remove();
            dotLayer.selectAll("*").remove();
            labelLayer.selectAll("*").remove();

            if (AppState.view.showPhases) {
                const phases = phaseLayer.selectAll(".phase-group").data(AppState.data.phases).join("g").attr("class", "phase-group");

                // 1. Header Backgrounds (Higher Opacity)
                phases.append("rect")
                    .attr("x", d => scaleX(d.start))
                    .attr("y", 0)
                    .attr("width", d => Math.max(1, scaleX(d.end) - scaleX(d.start)))
                    .attr("height", AppState.view.margin.top)
                    .attr("fill", (d, i) => {
                        if (d.type === 'surgery') return `rgba(239, 68, 68, ${AppState.view.phaseOpacity + 0.15})`;
                        const palette = [
                            `rgba(239, 68, 68, ${AppState.view.phaseOpacity + 0.1})`,
                            `rgba(249, 115, 22, ${AppState.view.phaseOpacity + 0.1})`,
                            `rgba(234, 179, 8, ${AppState.view.phaseOpacity + 0.1})`,
                            `rgba(34, 197, 94, ${AppState.view.phaseOpacity + 0.1})`,
                            `rgba(6, 182, 212, ${AppState.view.phaseOpacity + 0.1})`,
                            `rgba(59, 130, 246, ${AppState.view.phaseOpacity + 0.1})`,
                            `rgba(168, 85, 247, ${AppState.view.phaseOpacity + 0.1})`
                        ];
                        return palette[i % palette.length];
                    });

                // 2. Body Backgrounds (Normal Opacity)
                phases.append("rect")
                    .attr("x", d => scaleX(d.start))
                    .attr("y", AppState.view.margin.top)
                    .attr("width", d => Math.max(1, scaleX(d.end) - scaleX(d.start)))
                    .attr("height", AppState.view.height - AppState.view.margin.bottom - AppState.view.margin.top)
                    .attr("fill", (d, i) => {
                        if (d.type === 'surgery') return `rgba(239, 68, 68, ${AppState.view.phaseOpacity + 0.05})`;
                        const palette = [
                            `rgba(239, 68, 68, ${AppState.view.phaseOpacity})`,
                            `rgba(249, 115, 22, ${AppState.view.phaseOpacity})`,
                            `rgba(234, 179, 8, ${AppState.view.phaseOpacity})`,
                            `rgba(34, 197, 94, ${AppState.view.phaseOpacity})`,
                            `rgba(6, 182, 212, ${AppState.view.phaseOpacity})`,
                            `rgba(59, 130, 246, ${AppState.view.phaseOpacity})`,
                            `rgba(168, 85, 247, ${AppState.view.phaseOpacity})`
                        ];
                        return palette[i % palette.length];
                    });

                // Cycle Name + Duration (Two-line format) in Header
                const textGroup = phases.append("text")
                    .attr("x", d => scaleX(d.start) + (scaleX(d.end) - scaleX(d.start)) / 2)
                    .attr("y", 15) // Fixed top position
                    .attr("text-anchor", "middle")
                    .attr("fill", "#334155")
                    .attr("font-size", "9px")
                    .attr("font-weight", "bold");

                // First line: Cycle name (e.g., "C1")
                textGroup.append("tspan").text(d => d.cycle);

                // Second line: Duration in English (e.g., "20 days")
                textGroup.append("tspan")
                    .attr("x", d => scaleX(d.start) + (scaleX(d.end) - scaleX(d.start)) / 2)
                    .attr("dy", 10)
                    .text(d => `${d.duration} days`)
                    .attr("font-weight", "normal")
                    .attr("fill", "#64748b")
                    .attr("font-size", "8px");

                // Scheme Name (Smart Split by & or +) in Header
                if (AppState.view.showSchemes) {
                    phases.each(function (d) {
                        const el = d3.select(this).select("text");
                        // Split by & or + and trim whitespace
                        const parts = d.scheme.split(/[&+]/).map(s => s.trim()).filter(s => s);
                        parts.forEach((part, i) => {
                            el.append("tspan")
                                .attr("x", scaleX(d.start) + (scaleX(d.end) - scaleX(d.start)) / 2)
                                .attr("dy", i === 0 ? 14 : 9) // Tighter spacing for multi-line list
                                .text(part)
                                .attr("font-weight", "500")
                                .attr("fill", "#475569") // Slate-600
                                .attr("font-size", "7.5px"); // Slightly smaller for better fit
                        });
                    });
                }
            }

            const eventLayer = gMain.select("#event-layer");
            eventLayer.selectAll(".event-marker").remove();
            if (AppState.view.showEvents) {
                const events = eventLayer.selectAll(".event-marker").data(AppState.data.events).join("g").attr("class", "event-marker");

                // Vertical Line
                events.append("line")
                    .attr("x1", d => scaleX(d.date))
                    .attr("x2", d => scaleX(d.date))
                    .attr("y1", AppState.view.margin.top)
                    .attr("y2", AppState.view.height - AppState.view.margin.bottom)
                    .attr("stroke", "#94a3b8")
                    .attr("stroke-width", 1.5) // Thicker line
                    .attr("stroke-dasharray", "3 3");

                // Flagpole Label (Inside Chart)
                // Vertical text, reading top to bottom
                const textY = AppState.view.margin.top + 8; // Start slightly below top margin

                // 2. Text (Foreground)
                events.append("text")
                    .text(d => d.name)
                    .attr("x", d => {
                        const side = d.overlapIndex % 2 === 0 ? 1 : -1; // Even: Right (1), Odd: Left (-1)
                        const depth = Math.floor(d.overlapIndex / 2); // 0, 0, 1, 1...
                        // Base offset 6px, plus 10px for each depth level
                        return scaleX(d.date) + side * (6 + depth * 10);
                    })
                    .attr("y", textY)
                    .attr("dy", "0.35em")
                    .style("writing-mode", "vertical-rl")
                    .style("text-orientation", "sideways")
                    .attr("text-anchor", "start") // Always start from top
                    .attr("fill", "#334155")
                    .attr("font-size", "7.5px") // Reverted to 7.5px
                    .style("font-weight", "500"); // Reverted to 500

                // Optional: A small dot at the anchor point on the line
                events.append("circle")
                    .attr("cx", d => scaleX(d.date))
                    .attr("cy", textY - 3)
                    .attr("r", 4) // Larger dot
                    .attr("fill", "#94a3b8");
            }

            const active = Object.values(AppState.data.metrics).filter(m => m.active);

            active.forEach(m => {
                const customY = (val) => y(((val - m.mid) * m.scale) + m.mid + m.offset);

                // Draw Lines only if showLine is true
                if (m.showLine) {
                    // Clip data lines to chart area (below separator)
                    const line = d3.line().x(d => scaleX(d.date)).y(d => customY(d.value)).curve(d3.curveCatmullRom);

                    // Removed per-metric clip creation

                    lineLayer.append("path").datum(m.data).attr("class", "metric-path").attr("d", line).attr("fill", "none").attr("stroke", "white").attr("stroke-width", 3).attr("stroke-opacity", 0.8 * m.opacity);
                    lineLayer.append("path").datum(m.data).attr("class", "metric-path").attr("d", line).attr("fill", "none").attr("stroke", m.color).attr("stroke-width", 1.5).attr("stroke-opacity", m.opacity);
                }

                // Alert Pulse
                dotLayer.append("g").attr("class", "alert-pulse").selectAll("circle").data(m.data.filter(d => d.isAlert)).join("circle").attr("cx", d => scaleX(d.date)).attr("cy", d => customY(d.value)).attr("r", 6).attr("class", "alert-dot-pulse").attr("stroke-opacity", m.opacity);

                // Dots
                const dots = dotLayer.append("g").attr("class", "metric-dots");
                dots.selectAll("circle").data(m.data).join("circle").attr("cx", d => scaleX(d.date)).attr("cy", d => customY(d.value))
                    .attr("r", d => d.isAlert ? 4.5 : 3.5)
                    .attr("fill", d => d.isAlert ? "#ef4444" : m.color) // Solid fill
                    .attr("stroke", "white") // White stroke for contrast
                    .attr("stroke-width", 1.5)
                    .attr("fill-opacity", m.opacity)
                    .attr("stroke-opacity", m.opacity)
                    .on("touchstart mouseenter", (e, d) => { e.preventDefault(); showTooltip(e.type === 'touchstart' ? e.touches[0] : e, d, m); }).on("touchend mouseleave", () => document.getElementById('tooltip').style.opacity = 0);

                // Value Labels
                if (m.showValues) {
                    labelLayer.append("g").attr("class", "metric-value-labels")
                        .selectAll("text").data(m.data).join("text")
                        .attr("x", d => scaleX(d.date))
                        .attr("y", d => customY(d.value) - 8)
                        .attr("text-anchor", "middle")
                        .attr("font-size", "9px")
                        .attr("font-weight", "bold")
                        .attr("fill", d => d.isAlert ? "#ef4444" : m.color)
                        .attr("opacity", m.opacity * 0.9)
                        .text(d => d.value.toFixed(1));
                }
            });
        }

        function showTooltip(event, d, metric) {
            const tooltip = document.getElementById('tooltip');
            const box = document.getElementById('chart-container').getBoundingClientRect();
            const phase = AppState.data.phases.find(p => d.date >= p.start && d.date <= p.end);
            document.getElementById('tooltip-date').innerText = d3.timeFormat("%y/%m/%d")(d.date);
            document.getElementById('tooltip-cycle').innerText = phase ? phase.cycle : 'N/A';
            let statusHtml = `<span class="font-bold text-slate-800">${d.value}</span>`;
            if (d.isAlert) statusHtml += ` <span class="text-red-600 font-bold text-[10px] ml-2">⚠️ High (> ${metric.threshold})</span>`;
            document.getElementById('tooltip-body').innerHTML = `<div class="flex justify-between items-center"><span style="color:${metric.color}" class="font-bold mr-2">${metric.name}</span>${statusHtml}</div>`;
            tooltip.style.opacity = 1;
            let left = event.clientX - box.left + 10;
            let top = event.clientY - box.top - 10;
            if (left + 160 > box.width) left -= 170;
            if (top + 80 > box.height) top -= 80;
            tooltip.style.transform = `translate(${left}px, ${top}px)`;
        }

        window.addEventListener('resize', () => drawChart(true));

        // Auto-resize for print
        let originalMargin = null;
        window.onbeforeprint = () => {
            AppState.view.isPrinting = true;
            // Store original margins
            originalMargin = { ...AppState.view.margin };

            // Capture current visible domain
            if (svg && x) {
                const transform = d3.zoomTransform(svg.node());
                AppState.view.printDomain = transform.rescaleX(x).domain();
            }

            // Optimize margins for print (A4 Landscape) - Aggressive
            AppState.view.margin.top = 45;    // Reduced to 45
            AppState.view.margin.bottom = 25; // Increased slightly to 25 for axis safety
            AppState.view.margin.left = 10;   // Reduced to 10
            AppState.view.margin.right = 10;  // Reduced to 10

            // Title is now KEPT visible per user request
            // const titleEl = document.getElementById('chart-title');
            // if (titleEl) titleEl.style.display = 'none';

            drawChart(true);
        };
        window.onafterprint = () => {
            AppState.view.isPrinting = false;
            AppState.view.printDomain = null; // Clear print domain

            // Restore original margins
            if (originalMargin) {
                AppState.view.margin = originalMargin;
            }

            // Title visibility restoration not needed as we didn't hide it
            // const titleEl = document.getElementById('chart-title');
            // if (titleEl) titleEl.style.display = '';

            drawChart(true);
        };

        ['phases', 'events', 'schemes'].forEach(k => document.getElementById(`toggle-${k}`).addEventListener('change', (e) => {
            AppState.view[`show${k.charAt(0).toUpperCase() + k.slice(1)}`] = e.target.checked;
            saveSettings();
            drawChart(false);
        }));
        function drawChart(full = false) {
            if (full) {
                initChart();
                // Apply print zoom if needed
                if (AppState.view.isPrinting && AppState.view.printDomain && svg && zoom && x) {
                    const [d0, d1] = AppState.view.printDomain;
                    // x scale is now the base scale for the print width
                    // We need to find k and tx such that x'(d0) = margin.left and x'(d1) = width - margin.right
                    // x'(d) = x(d) * k + tx

                    // Calculate pixel positions in the NEW base scale
                    const x0 = x(d0);
                    const x1 = x(d1);

                    // Target pixel width for the domain
                    const targetWidth = AppState.view.width - AppState.view.margin.left - AppState.view.margin.right;

                    // Calculate scale factor k
                    // k * (x1 - x0) = targetWidth
                    const k = targetWidth / (x1 - x0);

                    // Calculate translation tx
                    // x0 * k + tx = AppState.view.margin.left
                    const tx = AppState.view.margin.left - x0 * k;

                    svg.call(zoom.transform, d3.zoomIdentity.translate(tx, 0).scale(k));
                }
            } else if (svg && zoom) {
                updateChart(d3.zoomTransform(svg.node()).rescaleX(x));
            }
        }

        const STORAGE_KEY = 'oncotracker_settings_v0.5';

        function resetSettings() {
            if (confirm("Reset all settings to default? This will clear your saved preferences.")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function saveSettings() {
            const settings = {
                view: {
                    showPhases: AppState.view.showPhases,
                    showEvents: AppState.view.showEvents,
                    showSchemes: AppState.view.showSchemes,
                    phaseOpacity: AppState.view.phaseOpacity
                },
                metrics: {}
            };
            Object.values(AppState.data.metrics).forEach(m => {
                settings.metrics[m.name] = {
                    active: m.active,
                    expanded: m.expanded,
                    scale: m.scale,
                    offset: m.offset,
                    opacity: m.opacity,
                    color: m.color,
                    showLine: m.showLine,
                    showValues: m.showValues
                };
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
        }

        function loadSettings() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return false;

                const saved = JSON.parse(raw);
                if (!saved) return false;

                if (saved.view) {
                    AppState.view.showPhases = saved.view.showPhases !== undefined ? saved.view.showPhases : true;
                    AppState.view.showEvents = saved.view.showEvents !== undefined ? saved.view.showEvents : true;
                    AppState.view.showSchemes = saved.view.showSchemes !== undefined ? saved.view.showSchemes : true;
                    if (saved.view.phaseOpacity !== undefined) AppState.view.phaseOpacity = saved.view.phaseOpacity;

                    // Update UI toggles
                    const togglePhases = document.getElementById('toggle-phases');
                    const toggleEvents = document.getElementById('toggle-events');
                    const toggleSchemes = document.getElementById('toggle-schemes');
                    const opacityInput = document.getElementById('phase-opacity');
                    const opacityVal = document.getElementById('phase-opacity-val');

                    if (togglePhases) togglePhases.checked = AppState.view.showPhases;
                    if (toggleEvents) toggleEvents.checked = AppState.view.showEvents;
                    if (toggleSchemes) toggleSchemes.checked = AppState.view.showSchemes;
                    if (opacityInput) opacityInput.value = AppState.view.phaseOpacity;
                    if (opacityVal) opacityVal.innerText = AppState.view.phaseOpacity;
                }

                if (saved.metrics) {
                    Object.entries(saved.metrics).forEach(([name, s]) => {
                        const m = AppState.data.metrics[name];
                        if (m) {
                            if (s.active !== undefined) m.active = s.active;
                            if (s.expanded !== undefined) m.expanded = s.expanded;
                            if (s.scale !== undefined) m.scale = s.scale;
                            if (s.offset !== undefined) m.offset = s.offset;
                            if (s.opacity !== undefined) m.opacity = s.opacity;
                            if (s.color !== undefined) m.color = s.color;
                            if (s.showLine !== undefined) m.showLine = s.showLine;
                            if (s.showValues !== undefined) m.showValues = s.showValues;
                        }
                    });
                }
                return true;
            } catch (e) {
                console.warn("Failed to load settings:", e);
                return false;
            }
        }

        try {
            processData();

            // Attempt to load settings
            const loaded = loadSettings();

            // If loading failed (or no settings existed), apply defaults
            if (!loaded) {
                console.log("No saved settings found or load failed. Applying defaults.");
                ["体重", "CEA", "CA125", "MRD"].forEach(n => { if (AppState.data.metrics[n]) AppState.data.metrics[n].active = true; });
            } else {
                console.log("Settings loaded successfully.");
            }

            renderControls();
            initChart();
        } catch (e) {
            alert("Error initializing chart: " + e.message + "\\n" + e.stack);
            console.error(e);
        }
    </script>
</body>

</html>